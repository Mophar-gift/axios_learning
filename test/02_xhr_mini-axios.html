<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>使用Promise+XHR简单封装一个发ajax请求的函数</title>
  </head>
  <body>
    <script>
      /*
        要求特点：
          1.函数的返回值为promise，成功的结果为response，异常的结果为error。
          2.能处理多种类型的请求：GET/POST/PUT/DELETE 。
          3.函数的参数为一个配置对象：
            {
              url: " ",       // 请求地址
              method: " ",    // 请求方式（GET/POST/PUT/DELETE）
              params: { },    // GET/DELETE请求的query参数
              data: { },      // POST/PUT请求的请求体参数
            }
          4.相应json数据自动解析为js对象/数组。

        要求概述：能发ajax请求的函数
          1.接收一个配置
          2.返回值是promise
          3.使用xhr发ajax请求
      */

      // 【使用Promise+XHR简单封装一个发ajax请求的函数】
      // (这里可以利用ES6的解构赋值，同时也可以加上默认值)
      function axios({ url, method = 'GET', params = {}, data = {} }) {
        if (params) {
          let queryString = '';
          Object.keys(params).forEach(key => {
            queryString += `&${key}=${params[key]}`;
          });
          url += '?' + queryString.slice(1);
        }
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();

          xhr.onreadystatechange = () => {
            const { readyState, status, statusText } = xhr;
            if (readyState !== 4) return;
            if (status >= 200 && status < 300) {
              resolve({
                data: JSON.parse(xhr.response),
                status,
                statusText,
              });
            } else {
              reject(new Error('request error status:', status));
            }
          };

          xhr.open(method, url, true);
          if (method.toUpperCase() === 'POST' || method.toUpperCase() === 'PUT') {
            xhr.setRequestHeader('Content-Type', 'application/json;charset=utf-8');
            xhr.send(JSON.stringify(data));
          } else {
            xhr.send();
          }
        });
      }

      // function axios({ url, method = 'GET', params = {}, data = {} }) {
      //   // 准备query参数
      //   let queryStr = '';
      //   if (params) {
      //     Object.keys(params).forEach(key => {
      //       queryStr += `&${key}=${params[key]}`;
      //     });
      //     queryStr = queryStr.slice(1);
      //     url += '?' + queryStr;
      //   }

      //   return new Promise((resolve, reject) => {
      //     const xhr = new XMLHttpRequest();

      //     xhr.onreadystatechange = () => {
      //       // 利用结构赋值以便于后面的变量使用
      //       const { readyState, status, statusText } = xhr;
      //       if (readyState !== 4) return;
      //       if (status >= 200 && status < 300) {
      //         // 封装一个代表相应的对象
      //         const response = {
      //           data: JSON.parse(xhr.response),
      //           status,
      //           statusText,
      //         };
      //         resolve(response);
      //       } else {
      //         reject(new Error('request error status:' + status));
      //       }
      //     };

      //     xhr.open(method, url, true);
      //     // 判断请求方式：
      //     if (method.toUpperCase() === 'POST' || method.toUpperCase() === 'PUT') {
      //       // 设置请求头
      //       xhr.setRequestHeader('Content-Type', 'application/json;charset=utf-8');
      //       xhr.send(JSON.stringify(data));
      //     } else {
      //       xhr.send();
      //     }
      //   });
      // }

      function testGet() {
        axios({
          method: 'GET',
          url: 'http://localhost:3000/posts',
          params: {
            id: 3,
          },
        }).then(
          response => {
            // console.log('response:', response);
            console.log(response.data, response.status, response.statusText);
          },
          error => {
            console.log(error.message);
          }
        );
      }
      function testPost() {
        axios({
          method: 'POST',
          url: 'http://localhost:3000/posts',
          data: {
            title: 'Mophar玉树临风',
            author: 'DK',
          },
        }).then(
          response => {
            console.log(response.data, response.status, response.statusText);
          },
          error => {
            console.log(error.message);
          }
        );
      }
      function testPut() {
        axios({
          method: 'PUT',
          url: 'http://localhost:3000/posts/3',
          data: {
            title: 'json-server3',
            author: 'typicode',
          },
        }).then(
          response => {
            // console.log('response:', response);
            console.log(response.data, response.status, response.statusText);
          },
          error => {
            console.log(error.message);
          }
        );
      }
      function testDelete() {
        axios({
          method: 'DELETE',
          url: 'http://localhost:3000/posts/3',
        }).then(
          response => {
            // console.log('response:', response);
            console.log(response.data, response.status, response.statusText);
          },
          error => {
            console.log(error.message);
          }
        );
      }
    </script>

    <button onclick="testGet()">发送GET请求</button>
    <br />
    <button onclick="testPost()">发送POST请求</button>
    <br />
    <button onclick="testPut()">发送PUT请求</button>
    <br />
    <button onclick="testDelete()">发送DELETE请求</button>
  </body>
</html>
